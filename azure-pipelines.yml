trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  MAVEN_OPTS: "-Xmx1024m"
  MAVEN_CACHE_FOLDER: "$(Pipeline.Workspace)/.m2/repository"

steps:
  # Checkout your repo
  - task: Checkout@1
    displayName: "Checkout source code"
    inputs:
      clean: true

  # Cache Maven dependencies
  - task: Cache@2
    displayName: "Cache Maven dependencies"
    inputs:
      key: 'maven | "$(Agent.OS)" | **/pom.xml'
      restoreKeys: |
        maven | "$(Agent.OS)"
      path: $(MAVEN_CACHE_FOLDER)

  # Set up JDK 21
  - task: UseJavaVersion@1
    displayName: "Set up JDK 21"
    inputs:
      versionSpec: '21'
      architecture: 'x64'

  # Build Spring Boot app
  - script: |
      mvn -B clean package -DskipTests
    displayName: "Build Spring Boot application"

  # Run tests
  - script: |
      mvn test
    displayName: "Run tests"

  # Publish the built JAR file
  - task: PublishBuildArtifacts@1
    displayName: "Publish build artifacts"
    inputs:
      PathtoPublish: 'target'
      ArtifactName: 'springboot-app'
      publishLocation: 'Container'
